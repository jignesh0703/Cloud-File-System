<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Resumable Upload Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #progressContainer {
      margin-top: 20px;
      width: 100%;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
    }

    #progressBar {
      height: 25px;
      width: 0%;
      background: #4caf50;
      text-align: center;
      color: white;
      line-height: 25px;
      transition: width 0.2s ease;
    }

    #log {
      margin-top: 15px;
      font-size: 14px;
      color: #444;
    }
  </style>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
  <h1>Resumable Upload (Chunked)</h1>

  <input type="file" id="fileInput" multiple />
  <label for="filePassword">File Password:</label>
  <input type="password" id="filePassword" placeholder="Enter password" />
  <button onclick="UploadFiles()">Upload</button>

  <div id="progressContainer">
    <div id="progressBar">0%</div>
  </div>
  <p id="status">Waiting...</p>

  <div id="log"></div>

  <script>
    const socket = io("http://localhost:5000");

    socket.on("connect", () => {
      console.log("âœ… Connected to Socket.io server:", socket.id);
    });

    function updateProgress(percent, stage, message) {
      const bar = document.getElementById("progressBar");
      bar.style.width = percent + "%";
      bar.textContent = percent + "%";
      document.getElementById("status").innerHTML = `<strong>Stage:</strong> ${stage} | <strong>Message:</strong> ${message}`;
    }

    // Socket events
    socket.on("chunk-upload", (data) => {
      updateProgress(data.percent, "Chunk Upload", `Uploading chunks... (File ${data.currentFileIndex + 1}/${data.TotalFile})`);
    });

    socket.on("merge-process", (data) => {
      updateProgress(data.mergePercent, "Merging", `Merging chunks... (File ${data.currentFileIndex + 1}/${data.TotalFile})`);
    });

    socket.on("merge-done", (data) => {
      updateProgress(50, "Merging", `âœ… Merging completed! (File ${data.currentFileIndex + 1}/${data.TotalFile})`);
    });

    socket.on('compress-process', (data) => {
      updateProgress(data.percent, 'Compress', `Compressing file ${data.currentFileIndex + 1}/${data.TotalFile}`);
    });

    socket.on("cloud-upload-progress", (data) => {
      updateProgress(data.percent, "Cloud Upload", `Uploading to cloud... (File ${data.currentFileIndex + 1}/${data.TotalFile})`);
    });

    socket.on("all-files-complete", ({ data }) => {
      document.getElementById("log").innerHTML = `<p>ðŸŽ‰ All files uploaded successfully!</p>`;
    });

    async function UploadFiles() {
      const input = document.getElementById("fileInput");
      if (!input.files.length) return alert("Select a file first");
      const password = document.getElementById("filePassword").value;


      document.getElementById("progressBar").style.width = "0%";
      document.getElementById("progressBar").textContent = "0%";
      document.getElementById("status").textContent = "Starting...";

      const sessionId = Date.now().toString();
      const totalFiles = input.files.length;
      const chunkSize = 1 * 1024 * 1024; // 1MB chunks
      const allResponses = [];

      for (let f = 0; f < input.files.length; f++) {
        const file = input.files[f];
        const totalChunks = Math.ceil(file.size / chunkSize);
        const fileId = sessionId + "-" + f; // unique file identifier

        for (let i = 0; i < totalChunks; i++) {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append("chunk", chunk);
          formData.append("filename", file.name);
          formData.append("filetype", file.type);
          formData.append("filesize", file.size);
          formData.append("lastModified", file.lastModified);
          formData.append("chunkindex", i);
          formData.append("password", password);
          formData.append("totalchunk", totalChunks);
          formData.append("sessionId", sessionId);
          formData.append("fileId", fileId);
          formData.append("totalFiles", totalFiles);
          formData.append("socketId", socket.id);
          formData.append("provider", "aws");

          try {
            const res = await fetch("http://localhost:5000/api/file/upload", {
              method: "POST",
              body: formData
            });
            const json = await res.json();

            if (json.data && Array.isArray(json.data.files)) {
              allResponses.push(...json.data.files);
            }
          } catch (err) {
            console.error("Upload error:", err);
          }
        }
      }

      console.log("âœ… All uploaded files:", allResponses);
    }
  </script>
</body>

</html>